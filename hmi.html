<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DCS HMI PoC</title>
  <style>
    :root {
      --bg: #1A1A2E;
      --panel: #16213E;
      --header: #0D1B2A;
      --button: #0F3460;
      --button-disabled: #2A2A40;
      --text: #FFFFFF;
      --muted: #AAAAAA;
      --line: #2A2A40;
      --scope: #39CCCC;
      --green: #2ECC40;
      --yellow: #FFDC00;
      --blue: #0074D9;
      --red: #FF4136;
      --grey: #AAAAAA;
      --dark: #333333;
      --amber: #FF851B;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      user-select: none;
    }
    .app { display: flex; flex-direction: column; min-height: 100vh; }
    .header {
      background: var(--header);
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--line);
      position: sticky; top: 0; z-index: 10;
    }
    .scope { color: var(--scope); font-weight: 700; }
    .alarm-banner {
      display: none;
      align-items: center;
      gap: 10px;
      background: var(--red);
      padding: 10px 16px;
      font-weight: 700;
      cursor: pointer;
      border-bottom: 1px solid rgba(0,0,0,0.2);
    }
    .alarm-banner.warning { background: var(--amber); }
    .alarm-banner.info { background: var(--blue); }
    .content { flex: 1; padding: 12px; }
    .train-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(150px, 1fr));
      gap: 12px;
    }
    .coach-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px;
      cursor: pointer;
    }
    .coach-title { text-align: center; font-weight: 700; margin-bottom: 8px; }
    .door-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 6px; }
    .door {
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.25);
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700;
      height: 26px;
      position: relative;
      overflow: hidden;
    }
    .door.large { height: 64px; font-size: 14px; }
    .door.small { width: 100%; }
    .door[data-state="closed"] { background: var(--green); color: #fff; }
    .door[data-state="open"] { background: var(--yellow); color: #111; }
    .door[data-state="moving"] { background: var(--blue); color: #fff; animation: pulse 1s infinite; }
    .door[data-state="fault"] { background: var(--red); color: #fff; animation: flash 0.5s infinite; }
    .door[data-state="isolated"] {
      background: var(--grey); color: #111;
      background-image: repeating-linear-gradient(45deg, rgba(255,255,255,.2), rgba(255,255,255,.2) 6px, rgba(0,0,0,0.05) 6px, rgba(0,0,0,0.05) 12px);
    }
    .door[data-state="comm_lost"] { background: var(--dark); color: #ddd; }
    .badge { text-align: center; margin-top: 6px; font-size: 12px; color: var(--muted); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
    }
    .coach-layout {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 8px;
    }
    .door-detail {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .door-detail > div {
      background: #101a30;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      cursor: pointer;
    }
    .commands {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    button {
      border: 0;
      background: var(--button);
      color: #fff;
      font-weight: 700;
      border-radius: 8px;
      padding: 12px 10px;
      cursor: pointer;
    }
    button:disabled { background: var(--button-disabled); color: #666680; cursor: not-allowed; }
    .status-bar {
      background: #0F1427;
      border-top: 1px solid var(--line);
      color: #c9d1ff;
      font-family: monospace;
      padding: 6px 12px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .hidden { display: none !important; }
    .back { margin-bottom: 8px; }
    .legend { color: var(--muted); font-size: 13px; margin-top: 8px; }
    .legend-panel {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #101a30;
    }
    .legend-items {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #d6ddff;
    }
    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      flex: 0 0 auto;
    }
    .legend-swatch.closed { background: var(--green); }
    .legend-swatch.open { background: var(--yellow); }
    .legend-swatch.moving { background: var(--blue); }
    .legend-swatch.fault { background: var(--red); }
    .legend-swatch.isolated { background: var(--grey); }
    .legend-swatch.comm_lost { background: var(--dark); }
    .mono { font-family: monospace; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.45; } }
    @keyframes flash { 0%,49% { opacity: 1; } 50%,100% { opacity: 0.35; } }
    @media (max-width: 1200px) {
      .train-grid { grid-template-columns: repeat(4, minmax(130px, 1fr)); }
    }
    @media (max-width: 900px) {
      .train-grid { grid-template-columns: repeat(3, minmax(120px, 1fr)); }
      .commands { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .coach-layout,.door-detail { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div><strong>DCS HMI PoC</strong> ¬∑ <span id="trainId">Train T-01</span></div>
      <div class="scope" id="scopeLabel">SCOPE: TRAIN</div>
      <div id="clock" class="mono"></div>
    </div>
    <div id="alarmBanner" class="alarm-banner" title="Tap to navigate to source">üîî <span id="alarmText"></span></div>

    <div class="content">
      <section id="viewTrain"></section>
      <section id="viewCoach" class="hidden"></section>
      <section id="viewDoor" class="hidden"></section>
    </div>

    <div class="status-bar">
      <div id="etdStatus">ETD: HEALTHY</div>
      <div id="faultCount">Faults: 0</div>
      <div id="commStatus">Comm: OK</div>
      <div id="motionStatus">Speed: 0 km/h</div>
      <div id="idleStatus">Idle timeout: 30s</div>
    </div>
  </div>

  <script>
    (() => {
      const STATES = ["closed", "open", "moving", "fault", "isolated", "comm_lost"];
      const stateLabel = {
        closed: "LOCKED", open: "OPEN", moving: "MOVING",
        fault: "FAULT", isolated: "ISO", comm_lost: "?"
      };

      const model = {
        trainId: "T-01",
        side: "BOTH",
        speed: 0,
        inactivitySec: 30,
        currentView: { level: 1, coach: null, door: null },
        alarms: [],
        coaches: Array.from({ length: 12 }, (_, ci) => ({
          id: ci + 1,
          doors: Array.from({ length: 8 }, (_, di) => ({ id: di + 1, state: "closed", enabled: true, obstruction: false, lastCmd: "-" }))
        }))
      };

      const el = {
        clock: document.getElementById("clock"),
        scopeLabel: document.getElementById("scopeLabel"),
        alarmBanner: document.getElementById("alarmBanner"),
        alarmText: document.getElementById("alarmText"),
        viewTrain: document.getElementById("viewTrain"),
        viewCoach: document.getElementById("viewCoach"),
        viewDoor: document.getElementById("viewDoor"),
        faultCount: document.getElementById("faultCount"),
        commStatus: document.getElementById("commStatus"),
        motionStatus: document.getElementById("motionStatus")
      };

      let idleTimer;
      function touch() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
          if (model.currentView.level > 1) navigateTrain();
        }, model.inactivitySec * 1000);
      }
      ["click", "touchstart", "keydown"].forEach(evt => document.addEventListener(evt, touch));

      function nowClock() {
        const d = new Date();
        el.clock.textContent = d.toLocaleTimeString();
      }
      setInterval(nowClock, 1000); nowClock();

      function commandDisabled() { return model.speed > 0; }

      function sideAllowsDoor(doorId) {
        if (model.side === "BOTH") return true;
        const isLeftDoor = doorId <= 4;
        return model.side === "LEFT" ? isLeftDoor : !isLeftDoor;
      }

      function canCloseDoor(door) {
        return door.state !== 'fault' && !door.obstruction;
      }

      function mkDoor(door, large = false) {
        return `<div class="door ${large ? 'large' : 'small'}" data-state="${door.state}" title="Door ${door.id}: ${door.state}">D${door.id} ${stateLabel[door.state]}</div>`;
      }

      function countFaults() {
        return model.coaches.reduce((a,c)=>a + c.doors.filter(d => d.state === "fault" || d.state === "comm_lost").length,0);
      }

      function refreshAlarm() {
        const active = model.alarms[0];
        if (!active) {
          el.alarmBanner.style.display = "none";
          return;
        }
        el.alarmBanner.className = "alarm-banner " + (active.severity || "");
        el.alarmText.textContent = `${active.text} (C${active.coach} D${active.door})`;
        el.alarmBanner.style.display = "flex";
        el.alarmBanner.onclick = () => navigateDoor(active.coach, active.door);
      }

      function rebuildAlarms() {
        const alarms = [];
        model.coaches.forEach(c => c.doors.forEach(d => {
          if (d.state === "fault") alarms.push({ severity: "", text: "Door fault/obstruction", coach: c.id, door: d.id });
          if (d.state === "comm_lost") alarms.push({ severity: "warning", text: "Communication lost", coach: c.id, door: d.id });
        }));
        model.alarms = alarms;
      }

      function trainView() {
        const disabled = commandDisabled();
        el.scopeLabel.textContent = "SCOPE: TRAIN";
        el.viewCoach.classList.add("hidden");
        el.viewDoor.classList.add("hidden");
        el.viewTrain.classList.remove("hidden");

        el.viewTrain.innerHTML = `
          <div class="train-grid">
            ${model.coaches.map(c => {
              const anyFault = c.doors.some(d => d.state === "fault");
              const allCommLost = c.doors.every(d => d.state === "comm_lost");
              const badge = allCommLost ? "COMM LOST" : anyFault ? "FAULT" : "OK";
              return `<div class="coach-card" data-coach="${c.id}">
                <div class="coach-title">C${c.id}</div>
                <div class="door-row">${c.doors.slice(0,4).map(d => mkDoor(d)).join("")}</div>
                <div class="door-row">${c.doors.slice(4,8).map(d => mkDoor(d)).join("")}</div>
                <div class="badge">${badge}</div>
              </div>`;
            }).join("")}
          </div>
          <div class="commands">
            <button id="openAll" ${disabled?"disabled":""}>OPEN ALL</button>
            <button id="closeAll" ${disabled?"disabled":""}>CLOSE ALL</button>
            <button id="enableAll" ${disabled?"disabled":""}>ENABLE ALL</button>
            <button id="disableAll" ${disabled?"disabled":""}>DISABLE ALL</button>
            <button id="resetAll" ${disabled?"disabled":""}>RESET ALL</button>
            <button id="toggleSide">SIDE: ${model.side}</button>
          </div>
          ${disabled ? '<div class="legend">Door Commands Disabled ‚Äî Train in Motion</div>' : ''}
          <div class="legend-panel">
            <strong>Door State Legend</strong>
            <div class="legend-items">
              <div class="legend-item"><span class="legend-swatch closed"></span>Closed / Locked</div>
              <div class="legend-item"><span class="legend-swatch open"></span>Open</div>
              <div class="legend-item"><span class="legend-swatch moving"></span>Moving</div>
              <div class="legend-item"><span class="legend-swatch fault"></span>Fault / Obstruction</div>
              <div class="legend-item"><span class="legend-swatch isolated"></span>Isolated</div>
              <div class="legend-item"><span class="legend-swatch comm_lost"></span>Communication Lost</div>
            </div>
          </div>
        `;

        el.viewTrain.querySelectorAll('.coach-card').forEach(n => n.onclick = () => navigateCoach(Number(n.dataset.coach)));
        el.viewTrain.querySelector('#openAll').onclick = () => confirmAction('Open all selected-side doors on train?', () => setAllDoors('open', 'open_all'));
        el.viewTrain.querySelector('#closeAll').onclick = () => confirmAction('Close all selected-side doors on train?', () => setAllDoors('closed', 'close_all'));
        el.viewTrain.querySelector('#enableAll').onclick = () => confirmAction('Enable all doors on train?', () => setAllEnable(true));
        el.viewTrain.querySelector('#disableAll').onclick = () => confirmAction('Disable all doors on train?', () => setAllEnable(false));
        el.viewTrain.querySelector('#resetAll').onclick = () => confirmAction('Reset all faults?', () => resetAllFaults());
        el.viewTrain.querySelector('#toggleSide').onclick = () => {
          model.side = model.side === 'LEFT' ? 'RIGHT' : model.side === 'RIGHT' ? 'BOTH' : 'LEFT';
          render();
        };
      }

      function coachView(coachId) {
        const coach = model.coaches[coachId-1];
        const disabled = commandDisabled();
        el.scopeLabel.textContent = `SCOPE: COACH ${coachId}`;
        el.viewTrain.classList.add('hidden');
        el.viewDoor.classList.add('hidden');
        el.viewCoach.classList.remove('hidden');

        el.viewCoach.innerHTML = `
          <button class="back" id="backTrain">‚Üê Back to Train</button>
          <div class="panel">
            <h3 style="margin:0 0 8px;">Coach ${coachId}</h3>
            <div class="coach-layout">${coach.doors.map(d => `<div onclick="window.HMI.navigateDoor(${coachId},${d.id})">${mkDoor(d, true)}</div>`).join('')}</div>
            <div class="legend">Tap a door to open Level 3 detail.</div>
          </div>
          <div class="commands">
            <button id="openCoach" ${disabled?"disabled":""}>OPEN COACH</button>
            <button id="closeCoach" ${disabled?"disabled":""}>CLOSE COACH</button>
            <button id="enableCoach" ${disabled?"disabled":""}>ENABLE COACH</button>
            <button id="disableCoach" ${disabled?"disabled":""}>DISABLE COACH</button>
            <button id="resetCoach" ${disabled?"disabled":""}>RESET COACH</button>
          </div>
          ${disabled ? '<div class="legend">Door Commands Disabled ‚Äî Train in Motion</div>' : ''}
        `;
        document.getElementById('backTrain').onclick = navigateTrain;
        document.getElementById('openCoach').onclick = () => confirmAction(`Open selected-side doors in coach ${coachId}?`, () => setCoachDoors(coachId,'open'));
        document.getElementById('closeCoach').onclick = () => confirmAction(`Close selected-side doors in coach ${coachId}?`, () => setCoachDoors(coachId,'closed'));
        document.getElementById('enableCoach').onclick = () => confirmAction(`Enable coach ${coachId}?`, () => setCoachEnable(coachId,true));
        document.getElementById('disableCoach').onclick = () => confirmAction(`Disable coach ${coachId}?`, () => setCoachEnable(coachId,false));
        document.getElementById('resetCoach').onclick = () => confirmAction(`Reset faults in coach ${coachId}?`, () => resetCoachFaults(coachId));
      }

      function doorView(coachId, doorId) {
        const coach = model.coaches[coachId-1];
        const door = coach.doors[doorId-1];
        const disabled = commandDisabled();
        const closeDisabled = disabled || !canCloseDoor(door);
        el.scopeLabel.textContent = `SCOPE: C${coachId} D${doorId}`;
        el.viewTrain.classList.add('hidden');
        el.viewCoach.classList.add('hidden');
        el.viewDoor.classList.remove('hidden');

        el.viewDoor.innerHTML = `
          <button class="back" id="backCoach">‚Üê Back to Coach ${coachId}</button>
          <div class="panel">
            <h3 style="margin-top:0;">Door Detail ¬∑ Coach ${coachId} Door ${doorId}</h3>
            ${mkDoor(door, true)}
            <div class="door-detail">
              <div><div>State</div><strong>${door.state.toUpperCase()}</strong></div>
              <div><div>Enabled</div><strong>${door.enabled ? 'YES' : 'NO'}</strong></div>
              <div><div>Last Cmd</div><strong>${door.lastCmd}</strong></div>
              <div><div>Obstruction</div><strong>${door.obstruction ? 'TRUE' : 'FALSE'}</strong></div>
            </div>
            <div class="commands" style="margin-top:10px;">
              <button id="cmdOpen" ${disabled?"disabled":""}>OPEN</button>
              <button id="cmdClose" ${closeDisabled?"disabled":""}>CLOSE</button>
              <button id="cmdEnable" ${disabled?"disabled":""}>ENABLE</button>
              <button id="cmdDisable" ${disabled?"disabled":""}>DISABLE</button>
              <button id="cmdReset" ${disabled?"disabled":""}>RESET FAULT</button>
            </div>
            ${disabled ? '<div class="legend">Door Commands Disabled ‚Äî Train in Motion</div>' : ''}
          </div>
        `;
        document.getElementById('backCoach').onclick = () => navigateCoach(coachId);
        document.getElementById('cmdOpen').onclick = () => setDoor(coachId,doorId,{state:'open',lastCmd:'open'});
        document.getElementById('cmdClose').onclick = () => {
          if (!canCloseDoor(door)) return;
          setDoor(coachId,doorId,{state:'closed',lastCmd:'close'});
        };
        document.getElementById('cmdEnable').onclick = () => setDoor(coachId,doorId,{enabled:true,lastCmd:'enable'});
        document.getElementById('cmdDisable').onclick = () => setDoor(coachId,doorId,{enabled:false,lastCmd:'disable'});
        document.getElementById('cmdReset').onclick = () => setDoor(coachId,doorId,{state:'closed',obstruction:false,lastCmd:'reset'});
      }

      function confirmAction(msg, fn) {
        if (!commandDisabled() && window.confirm(msg)) fn();
      }

      function setDoor(coachId, doorId, patch) {
        Object.assign(model.coaches[coachId-1].doors[doorId-1], patch);
        render();
      }
      function setAllDoors(state, cmd) {
        model.coaches.forEach(c => c.doors.forEach(d => {
          if (!sideAllowsDoor(d.id)) return;
          if (state === 'closed' && !canCloseDoor(d)) return;
          d.state = state;
          d.lastCmd = cmd + '_' + model.side.toLowerCase();
        }));
        render();
      }
      function setCoachDoors(coachId, state) {
        model.coaches[coachId-1].doors.forEach(d => {
          if (!sideAllowsDoor(d.id)) return;
          if (state === 'closed' && !canCloseDoor(d)) return;
          d.state = state;
          d.lastCmd = 'coach_' + state + '_' + model.side.toLowerCase();
        });
        render();
      }
      function setAllEnable(v) { model.coaches.forEach(c => c.doors.forEach(d => { d.enabled=v; d.lastCmd=(v?'enable_all':'disable_all'); })); render(); }
      function setCoachEnable(coachId,v) { model.coaches[coachId-1].doors.forEach(d => { d.enabled=v; d.lastCmd=(v?'enable_coach':'disable_coach'); }); render(); }
      function resetAllFaults() { model.coaches.forEach(c => c.doors.forEach(d => { if (d.state==='fault'||d.state==='comm_lost') d.state='closed'; d.obstruction=false; d.lastCmd='reset_all'; })); render(); }
      function resetCoachFaults(coachId) { model.coaches[coachId-1].doors.forEach(d => { if (d.state==='fault'||d.state==='comm_lost') d.state='closed'; d.obstruction=false; d.lastCmd='reset_coach'; }); render(); }

      function navigateTrain() { model.currentView = { level: 1, coach: null, door: null }; render(); }
      function navigateCoach(coach) { model.currentView = { level: 2, coach, door: null }; render(); }
      function navigateDoor(coach, door) { model.currentView = { level: 3, coach, door }; render(); }

      function render() {
        rebuildAlarms();
        refreshAlarm();
        el.faultCount.textContent = `Faults: ${countFaults()}`;
        el.commStatus.textContent = model.coaches.some(c => c.doors.some(d=>d.state==='comm_lost')) ? 'Comm: DEGRADED' : 'Comm: OK';
        el.motionStatus.textContent = `Speed: ${model.speed} km/h`;

        if (model.currentView.level === 1) trainView();
        if (model.currentView.level === 2) coachView(model.currentView.coach);
        if (model.currentView.level === 3) doorView(model.currentView.coach, model.currentView.door);
      }

      function randomize(seedFaultRate = 0.08) {
        model.coaches.forEach(c => c.doors.forEach(d => {
          d.state = Math.random() < seedFaultRate ? (Math.random() < 0.6 ? 'fault' : 'comm_lost') : STATES[Math.floor(Math.random()*4)];
          d.enabled = Math.random() > 0.1;
          d.lastCmd = 'trdp_update';
          d.obstruction = d.state === 'fault';
        }));
        render();
      }

      window.HMI = {
        model,
        render,
        navigateTrain,
        navigateCoach,
        navigateDoor,
        setSpeed: (kmh) => { model.speed = Number(kmh) || 0; render(); },
        setDoorState: (coach, door, state) => {
          if (!STATES.includes(state)) throw new Error(`state must be one of ${STATES.join(', ')}`);
          setDoor(coach, door, { state, lastCmd: 'console_set', obstruction: state==='fault' });
        },
        setDoorEnabled: (coach, door, enabled) => setDoor(coach, door, { enabled: !!enabled, lastCmd: 'console_enable' }),
        injectTRDP: (payload) => {
          // payload: [{coach:1, door:2, state:'open', enabled:true}]
          payload.forEach(p => {
            if (!p.coach || !p.door) return;
            const patch = {};
            if (p.state) patch.state = p.state;
            if (typeof p.enabled === 'boolean') patch.enabled = p.enabled;
            patch.lastCmd = 'trdp_inject';
            if (patch.state === 'fault') patch.obstruction = true;
            setDoor(p.coach, p.door, patch);
          });
          render();
        },
        randomize,
        help: () => console.log(`HMI console API:\nHMI.setSpeed(45)\nHMI.setDoorState(3,4,'fault')\nHMI.setDoorEnabled(3,4,false)\nHMI.injectTRDP([{coach:1,door:1,state:'open'}])\nHMI.randomize()\nHMI.navigateCoach(4)`) 
      };

      touch();
      render();
      randomize(0.02);
      console.log('DCS HMI PoC loaded. Run HMI.help() for API.');
    })();
  </script>
</body>
</html>
